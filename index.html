<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <title>To Be. | Gem Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root { --primary: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: contain;
        }
        input, textarea { -webkit-user-select: text; user-select: text; }
        .glass-card {
            background-color: white;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border-radius: 1.5rem;
        }
        .dark .glass-card {
            background-color: #0f172a;
            border: 1px solid #1e293b;
            box-shadow: none;
        }
        .nav-active { color: var(--primary); font-weight: 800; }
        .tab-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors">

    <div id="app" class="min-h-screen flex flex-col max-w-md mx-auto relative overflow-x-hidden">
        
        <!-- Auth Screen -->
        <div id="auth-screen" class="fixed inset-0 z-[100] bg-indigo-600 flex flex-col items-center justify-center p-8 transition-all duration-500">
            <div class="mb-10 text-center">
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl">
                    <span class="text-3xl font-black text-indigo-600">TB</span>
                </div>
                <h1 class="text-3xl font-black text-white">To Be.</h1>
                <p class="text-indigo-100 font-bold opacity-70 text-[10px] tracking-widest uppercase">By Gem Labs</p>
            </div>
            
            <div class="w-full space-y-3" id="auth-forms">
                <div id="login-form" class="space-y-3">
                    <input type="email" id="email" placeholder="Email Address" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none focus:bg-white/20">
                    <input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none focus:bg-white/20">
                    <button onclick="authLogic.handleAuth('login')" class="w-full py-4 bg-white text-indigo-600 rounded-2xl font-black shadow-lg">Login</button>
                    <button onclick="authLogic.toggleMode()" class="w-full text-white/60 text-xs font-bold">New here? Create Account</button>
                </div>
            </div>
            <div id="auth-status" class="mt-4 text-white text-xs font-medium text-center"></div>
        </div>

        <!-- Main UI -->
        <header class="p-6 flex justify-between items-center sticky top-0 bg-inherit/80 backdrop-blur-md z-40">
            <div>
                <h2 class="text-2xl font-black tracking-tighter">To <span class="text-indigo-600">Be.</span></h2>
                <div class="flex items-center gap-1">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="user-display">Guest User</p>
                    <button onclick="authLogic.logout()" class="text-[8px] font-bold text-rose-500 uppercase">Logout</button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="ui.toggleTheme()" class="p-3 glass-card rounded-2xl">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-indigo-600"></i>
                </button>
            </div>
        </header>

        <main id="main-view" class="flex-grow px-6 pb-36 overflow-y-auto">
            <!-- Dynamic Content -->
        </main>

        <!-- Navigation -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] z-50">
            <div class="glass-card p-2 flex justify-around items-center bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl">
                <button onclick="router.navigate('timetable')" id="nav-timetable" class="p-3 flex flex-col items-center gap-1 text-slate-400">
                    <i data-lucide="calendar-days" class="w-5 h-5"></i>
                    <span class="text-[9px] font-black uppercase">Plan</span>
                </button>
                <button onclick="router.navigate('tasks')" id="nav-tasks" class="p-3 flex flex-col items-center gap-1 text-slate-400">
                    <i data-lucide="list-todo" class="w-5 h-5"></i>
                    <span class="text-[9px] font-black uppercase">Tasks</span>
                </button>
                <button onclick="router.navigate('focus')" id="nav-focus" class="p-3 flex flex-col items-center gap-1 text-slate-400">
                    <i data-lucide="timer" class="w-5 h-5"></i>
                    <span class="text-[9px] font-black uppercase">Focus</span>
                </button>
                <button onclick="router.navigate('sleep')" id="nav-sleep" class="p-3 flex flex-col items-center gap-1 text-slate-400">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                    <span class="text-[9px] font-black uppercase">Sleep</span>
                </button>
            </div>
        </nav>
        
        <!-- Links -->
        <div class="fixed bottom-1 left-0 right-0 flex justify-center gap-4 text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-1">
            <a href="https://gem-labs-pk.github.io/To-Be/" target="_blank">App Home</a>
            <span>|</span>
            <a href="https://gem-labs-pk.github.io/Gem-PWA-Store/" target="_blank">Gem PWA Store</a>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="fixed inset-0 z-[110] bg-slate-950/40 backdrop-blur-sm hidden flex items-end justify-center p-4">
        <div class="w-full max-w-sm glass-card p-6 animate-in slide-in-from-bottom-10 duration-300">
            <div id="modal-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app_id = typeof __app_id !== 'undefined' ? __app_id : 'to-be-productivity';
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- State ---
        let user = null;
        let userData = {
            tasks: [],
            timetable: { Monday: [], Tuesday: [], Wednesday: [], Thursday: [], Friday: [], Saturday: [], Sunday: [] },
            pomodoro: { focus: 25, break: 5, cycles: 4 }
        };
        let currentDay = new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(new Date());
        let timer = { timeLeft: 1500, active: false, interval: null, mode: 'Focus', count: 1 };

        // --- Auth Logic ---
        window.authLogic = {
            mode: 'login',
            toggleMode: () => {
                authLogic.mode = authLogic.mode === 'login' ? 'signup' : 'login';
                const form = document.getElementById('login-form');
                form.innerHTML = authLogic.mode === 'login' ? `
                    <input type="email" id="email" placeholder="Email Address" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none">
                    <input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none">
                    <button onclick="authLogic.handleAuth('login')" class="w-full py-4 bg-white text-indigo-600 rounded-2xl font-black">Login</button>
                    <button onclick="authLogic.toggleMode()" class="w-full text-white/60 text-xs font-bold">New here? Create Account</button>
                ` : `
                    <input type="email" id="email" placeholder="New Email" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none">
                    <input type="password" id="password" placeholder="Create Password" class="w-full p-4 rounded-2xl bg-white/10 border border-white/20 text-white placeholder:text-white/40 outline-none">
                    <button onclick="authLogic.handleAuth('signup')" class="w-full py-4 bg-white text-indigo-600 rounded-2xl font-black">Sign Up</button>
                    <button onclick="authLogic.toggleMode()" class="w-full text-white/60 text-xs font-bold">Already have an account? Login</button>
                `;
            },
            handleAuth: async (type) => {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                const status = document.getElementById('auth-status');
                status.innerText = "Processing...";

                try {
                    if (type === 'signup') {
                        const res = await createUserWithEmailAndPassword(auth, email, pass);
                        await sendEmailVerification(res.user);
                        // Track User
                        await setDoc(doc(db, 'artifacts', app_id, 'public', 'data', 'users', res.user.uid), {
                            email: email,
                            joined: Date.now()
                        });
                        // Init Private Data
                        await setDoc(doc(db, 'artifacts', app_id, 'users', res.user.uid, 'settings', 'profile'), userData);
                        status.innerText = "Check your email for verification link!";
                    } else {
                        const res = await signInWithEmailAndPassword(auth, email, pass);
                        if (!res.user.emailVerified) {
                            status.innerText = "Please verify your email first.";
                            await signOut(auth);
                            return;
                        }
                    }
                } catch (err) {
                    status.innerText = err.message;
                }
            },
            logout: () => signOut(auth)
        };

        // --- Core UI & Logic ---
        window.ui = {
            render: () => {
                const main = document.getElementById('main-view');
                const view = router.current;
                
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
                document.getElementById(`nav-${view}`).classList.add('nav-active');

                if (view === 'timetable') ui.viewTimetable(main);
                if (view === 'tasks') ui.viewTasks(main);
                if (view === 'focus') ui.viewFocus(main);
                if (view === 'sleep') ui.viewSleep(main);

                lucide.createIcons();
            },
            viewTimetable: (c) => {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                c.innerHTML = `
                    <div class="mb-6">
                        <div class="flex overflow-x-auto gap-2 py-2 no-scrollbar">
                            ${days.map(d => `<button onclick="ui.setDay('${d}')" class="tab-btn px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap glass-card ${currentDay === d ? 'active' : ''}">${d}</button>`).join('')}
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-black">${currentDay} Plan</h3>
                        <button onclick="ui.openModal('slot')" class="bg-indigo-600 text-white text-[10px] px-4 py-2 rounded-xl font-black">+ Add Slot</button>
                    </div>
                    <div class="space-y-3">
                        ${(userData.timetable[currentDay] || []).map((s, idx) => `
                            <div class="glass-card p-4 flex justify-between items-center border-l-4 ${s.type === 'busy' ? 'border-l-indigo-600' : 'border-l-emerald-500'}">
                                <div><p class="text-[9px] font-bold text-slate-400">${s.time}</p><h4 class="font-bold">${s.label}</h4></div>
                                <button onclick="logic.deleteSlot(${idx})" class="text-slate-300"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            viewTasks: (c) => {
                c.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-black">Assignments</h3>
                        <button onclick="ui.openModal('task')" class="bg-indigo-600 text-white text-[10px] px-4 py-2 rounded-xl font-black">+ New</button>
                    </div>
                    <div class="space-y-2">
                        ${userData.tasks.map((t, idx) => `
                            <div class="glass-card p-4 flex items-center gap-3">
                                <button onclick="logic.toggleTask(${idx})" class="w-5 h-5 rounded border-2 border-indigo-600 flex items-center justify-center ${t.done ? 'bg-indigo-600' : ''}">
                                    ${t.done ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                                </button>
                                <span class="flex-grow font-bold ${t.done ? 'line-through opacity-40' : ''}">${t.text}</span>
                                <button onclick="logic.deleteTask(${idx})" class="text-slate-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            viewFocus: (c) => {
                const m = Math.floor(timer.timeLeft / 60);
                const s = timer.timeLeft % 60;
                c.innerHTML = `
                    <div class="text-center py-6">
                        <div class="w-64 h-64 glass-card mx-auto flex flex-col items-center justify-center relative mb-10">
                            <svg class="absolute inset-0 w-full h-full -rotate-90">
                                <circle cx="128" cy="128" r="120" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-100 dark:text-slate-800" />
                                <circle id="timer-ring" cx="128" cy="128" r="120" stroke="currentColor" stroke-width="8" fill="transparent" class="text-indigo-600 transition-all duration-1000" stroke-dasharray="754" />
                            </svg>
                            <span class="text-6xl font-black">${m}:${s < 10 ? '0'+s : s}</span>
                            <span class="text-[10px] font-bold text-indigo-600 uppercase tracking-widest mt-2">${timer.mode} Cycle ${timer.count}/${userData.pomodoro.cycles}</span>
                        </div>
                        <div class="flex gap-4 justify-center">
                            <button onclick="logic.toggleTimer()" class="px-10 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-500/30">
                                ${timer.active ? 'Pause' : 'Focus Now'}
                            </button>
                            <button onclick="ui.openModal('pomodoro-settings')" class="p-4 glass-card rounded-2xl"><i data-lucide="settings"></i></button>
                        </div>
                    </div>
                `;
                document.getElementById('timer-ring').style.strokeDashoffset = 754 - (754 * timer.timeLeft / (timer.mode === 'Focus' ? userData.pomodoro.focus * 60 : userData.pomodoro.break * 60));
            },
            viewSleep: (c) => {
                c.innerHTML = `<div class="glass-card p-10 text-center"><i data-lucide="moon" class="w-16 h-16 mx-auto mb-4 text-indigo-400"></i><h3 class="font-bold">Sleep tracking feature coming in next update!</h3></div>`;
            },
            setDay: (d) => { currentDay = d; ui.render(); },
            openModal: (type) => {
                const m = document.getElementById('modal');
                const content = document.getElementById('modal-content');
                m.classList.remove('hidden');
                
                if (type === 'slot') {
                    content.innerHTML = `
                        <h4 class="font-bold mb-4">Add Slot for ${currentDay}</h4>
                        <input id="sl-label" placeholder="Activity Name" class="w-full p-4 glass-card mb-2 outline-none">
                        <input id="sl-time" placeholder="Time (e.g. 10:00 - 12:00)" class="w-full p-4 glass-card mb-4 outline-none">
                        <div class="flex gap-2">
                            <button onclick="logic.addSlot('busy')" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">Busy</button>
                            <button onclick="logic.addSlot('free')" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold">Free</button>
                        </div>
                    `;
                } else if (type === 'task') {
                    content.innerHTML = `
                        <h4 class="font-bold mb-4">New Assignment</h4>
                        <input id="tk-val" placeholder="Assignment Title" class="w-full p-4 glass-card mb-4 outline-none">
                        <button onclick="logic.addTask()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">Save Task</button>
                    `;
                } else if (type === 'pomodoro-settings') {
                    content.innerHTML = `
                        <h4 class="font-bold mb-4">Pomodoro Settings</h4>
                        <div class="space-y-4">
                            <div><label class="text-[10px] font-bold">Focus (mins)</label><input id="ps-f" type="number" value="${userData.pomodoro.focus}" class="w-full p-3 glass-card outline-none"></div>
                            <div><label class="text-[10px] font-bold">Break (mins)</label><input id="ps-b" type="number" value="${userData.pomodoro.break}" class="w-full p-3 glass-card outline-none"></div>
                            <div><label class="text-[10px] font-bold">Cycles</label><input id="ps-c" type="number" value="${userData.pomodoro.cycles}" class="w-full p-3 glass-card outline-none"></div>
                            <button onclick="logic.saveSettings()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">Apply Changes</button>
                        </div>
                    `;
                }
            },
            closeModal: () => document.getElementById('modal').classList.add('hidden'),
            toggleTheme: () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
            }
        };

        window.logic = {
            addSlot: async (type) => {
                const label = document.getElementById('sl-label').value;
                const time = document.getElementById('sl-time').value;
                if (!label || !time) return;
                userData.timetable[currentDay].push({ label, time, type });
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
                ui.closeModal();
            },
            deleteSlot: async (idx) => {
                userData.timetable[currentDay].splice(idx, 1);
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
            },
            addTask: async () => {
                const text = document.getElementById('tk-val').value;
                if (!text) return;
                userData.tasks.unshift({ text, done: false });
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
                ui.closeModal();
            },
            toggleTask: async (idx) => {
                userData.tasks[idx].done = !userData.tasks[idx].done;
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
            },
            deleteTask: async (idx) => {
                userData.tasks.splice(idx, 1);
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
            },
            toggleTimer: () => {
                if (timer.active) {
                    clearInterval(timer.interval);
                    timer.active = false;
                } else {
                    timer.active = true;
                    timer.interval = setInterval(() => {
                        if (timer.timeLeft > 0) {
                            timer.timeLeft--;
                            ui.render();
                        } else {
                            logic.cycleTimer();
                        }
                    }, 1000);
                }
                ui.render();
            },
            cycleTimer: () => {
                clearInterval(timer.interval);
                timer.active = false;
                if (timer.mode === 'Focus') {
                    timer.mode = 'Break';
                    timer.timeLeft = userData.pomodoro.break * 60;
                } else {
                    timer.mode = 'Focus';
                    timer.count++;
                    timer.timeLeft = userData.pomodoro.focus * 60;
                    if (timer.count > userData.pomodoro.cycles) {
                        timer.count = 1;
                        alert("Work Day Complete!");
                    }
                }
                ui.render();
            },
            saveSettings: async () => {
                userData.pomodoro.focus = parseInt(document.getElementById('ps-f').value);
                userData.pomodoro.break = parseInt(document.getElementById('ps-b').value);
                userData.pomodoro.cycles = parseInt(document.getElementById('ps-c').value);
                timer.timeLeft = userData.pomodoro.focus * 60;
                await updateDoc(doc(db, 'artifacts', app_id, 'users', user.uid, 'settings', 'profile'), userData);
                ui.closeModal();
                ui.render();
            }
        };

        window.router = {
            current: 'timetable',
            navigate: (view) => {
                router.current = view;
                ui.render();
            }
        };

        // --- Auth Observer ---
        onAuthStateChanged(auth, async (u) => {
            const authScreen = document.getElementById('auth-screen');
            if (u && u.emailVerified) {
                user = u;
                document.getElementById('user-display').innerText = u.email;
                authScreen.classList.add('opacity-0', 'pointer-events-none');
                
                // Real-time data listener
                onSnapshot(doc(db, 'artifacts', app_id, 'users', u.uid, 'settings', 'profile'), (snap) => {
                    if (snap.exists()) {
                        userData = snap.data();
                        ui.render();
                    }
                }, (err) => console.log(err));
            } else {
                user = null;
                authScreen.classList.remove('opacity-0', 'pointer-events-none');
            }
        });
    </script>
</body>
</html>
